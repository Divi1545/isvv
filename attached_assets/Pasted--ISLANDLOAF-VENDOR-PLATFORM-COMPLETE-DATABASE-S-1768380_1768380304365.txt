-- ============================================
-- ISLANDLOAF VENDOR PLATFORM - COMPLETE DATABASE SETUP
-- ============================================
-- Copy and paste this ENTIRE script into Supabase SQL Editor
-- Run it all at once - it will create everything you need!
-- ============================================

-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================
-- CORE TABLES
-- ============================================

-- Users Table (Vendors & Admins)
CREATE TABLE IF NOT EXISTS users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  full_name VARCHAR(255),
  business_name VARCHAR(255),
  business_type VARCHAR(50),
  business_description TEXT,
  phone VARCHAR(50),
  address TEXT,
  city VARCHAR(100),
  country VARCHAR(100) DEFAULT 'Sri Lanka',
  role VARCHAR(20) NOT NULL DEFAULT 'vendor',
  is_approved BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  stripe_connected_account_id VARCHAR(255),
  stripe_onboarding_complete BOOLEAN DEFAULT false,
  profile_image VARCHAR(500),
  commission_rate DECIMAL(5, 2) DEFAULT 12.5,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_role CHECK (role IN ('vendor', 'admin')),
  CONSTRAINT valid_business_type CHECK (business_type IN ('stays', 'tours', 'vehicles', 'wellness', 'tickets', 'products'))
);

-- Services Table
CREATE TABLE IF NOT EXISTS services (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  type VARCHAR(50) NOT NULL,
  base_price DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  available BOOLEAN DEFAULT true,
  location VARCHAR(255),
  latitude DECIMAL(10, 8),
  longitude DECIMAL(11, 8),
  images TEXT[],
  amenities TEXT[],
  max_capacity INTEGER,
  min_booking_days INTEGER DEFAULT 1,
  cancellation_policy TEXT,
  house_rules TEXT,
  check_in_time TIME,
  check_out_time TIME,
  instant_booking BOOLEAN DEFAULT false,
  views_count INTEGER DEFAULT 0,
  rating DECIMAL(3, 2) DEFAULT 0,
  reviews_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_service_type CHECK (type IN ('stays', 'tours', 'vehicles', 'wellness', 'tickets', 'products'))
);

-- Bookings Table
CREATE TABLE IF NOT EXISTS bookings (
  id SERIAL PRIMARY KEY,
  booking_reference VARCHAR(50) UNIQUE NOT NULL,
  user_id INTEGER NOT NULL REFERENCES users(id),
  service_id INTEGER NOT NULL REFERENCES services(id),
  customer_name VARCHAR(255) NOT NULL,
  customer_email VARCHAR(255) NOT NULL,
  customer_phone VARCHAR(50),
  customer_country VARCHAR(100),
  guests_count INTEGER DEFAULT 1,
  start_date DATE NOT NULL,
  end_date DATE,
  nights_count INTEGER,
  total_price DECIMAL(10, 2) NOT NULL,
  commission DECIMAL(10, 2) DEFAULT 0,
  vendor_payout DECIMAL(10, 2),
  status VARCHAR(50) DEFAULT 'pending',
  payment_status VARCHAR(50) DEFAULT 'pending',
  notes TEXT,
  special_requests TEXT,
  stripe_payment_intent_id VARCHAR(255),
  stripe_charge_id VARCHAR(255),
  refund_amount DECIMAL(10, 2) DEFAULT 0,
  check_in_time TIMESTAMP,
  check_out_time TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_status CHECK (status IN ('pending', 'confirmed', 'completed', 'cancelled', 'refunded')),
  CONSTRAINT valid_payment_status CHECK (payment_status IN ('pending', 'processing', 'paid', 'failed', 'refunded'))
);

-- Calendar Sources Table
CREATE TABLE IF NOT EXISTS calendar_sources (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  service_id INTEGER REFERENCES services(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  url TEXT NOT NULL,
  type VARCHAR(50),
  sync_enabled BOOLEAN DEFAULT true,
  last_synced TIMESTAMP,
  sync_status VARCHAR(50) DEFAULT 'active',
  error_message TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_calendar_type CHECK (type IN ('airbnb', 'booking', 'google', 'ical', 'vrbo', 'other'))
);

-- Calendar Events Table
CREATE TABLE IF NOT EXISTS calendar_events (
  id SERIAL PRIMARY KEY,
  calendar_source_id INTEGER NOT NULL REFERENCES calendar_sources(id) ON DELETE CASCADE,
  service_id INTEGER REFERENCES services(id) ON DELETE CASCADE,
  booking_id INTEGER REFERENCES bookings(id) ON DELETE CASCADE,
  start_date TIMESTAMP NOT NULL,
  end_date TIMESTAMP NOT NULL,
  summary VARCHAR(255),
  description TEXT,
  is_blocked BOOLEAN DEFAULT true,
  event_type VARCHAR(50) DEFAULT 'booking',
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_event_type CHECK (event_type IN ('booking', 'blocked', 'maintenance', 'personal'))
);

-- ============================================
-- STRIPE CONNECT & PAYMENTS TABLES
-- ============================================

-- Stripe Connect Accounts Table
CREATE TABLE IF NOT EXISTS stripe_connect_accounts (
  id SERIAL PRIMARY KEY,
  user_id INTEGER UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  stripe_account_id VARCHAR(255) UNIQUE NOT NULL,
  account_type VARCHAR(50) NOT NULL,
  country VARCHAR(2) NOT NULL,
  email VARCHAR(255),
  charges_enabled BOOLEAN DEFAULT false,
  payouts_enabled BOOLEAN DEFAULT false,
  details_submitted BOOLEAN DEFAULT false,
  onboarding_complete BOOLEAN DEFAULT false,
  default_currency VARCHAR(3) DEFAULT 'USD',
  business_profile JSONB,
  requirements JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_account_type CHECK (account_type IN ('express', 'standard', 'custom'))
);

-- Vendor Payouts Table
CREATE TABLE IF NOT EXISTS vendor_payouts (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id),
  stripe_payout_id VARCHAR(255),
  stripe_transfer_id VARCHAR(255),
  amount DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  status VARCHAR(50) DEFAULT 'pending',
  payout_date DATE,
  booking_ids INTEGER[],
  failure_reason TEXT,
  description TEXT,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_payout_status CHECK (status IN ('pending', 'in_transit', 'paid', 'failed', 'cancelled'))
);

-- Transactions Table (Complete Payment History)
CREATE TABLE IF NOT EXISTS transactions (
  id SERIAL PRIMARY KEY,
  booking_id INTEGER REFERENCES bookings(id),
  user_id INTEGER REFERENCES users(id),
  transaction_type VARCHAR(50) NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  stripe_payment_intent_id VARCHAR(255),
  stripe_charge_id VARCHAR(255),
  stripe_refund_id VARCHAR(255),
  stripe_transfer_id VARCHAR(255),
  status VARCHAR(50) NOT NULL,
  description TEXT,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_transaction_type CHECK (transaction_type IN ('payment', 'refund', 'payout', 'commission', 'adjustment')),
  CONSTRAINT valid_transaction_status CHECK (status IN ('pending', 'succeeded', 'failed', 'cancelled'))
);

-- Commission Tracking Table
CREATE TABLE IF NOT EXISTS commissions (
  id SERIAL PRIMARY KEY,
  booking_id INTEGER NOT NULL REFERENCES bookings(id),
  user_id INTEGER NOT NULL REFERENCES users(id),
  booking_amount DECIMAL(10, 2) NOT NULL,
  commission_rate DECIMAL(5, 2) NOT NULL,
  commission_amount DECIMAL(10, 2) NOT NULL,
  vendor_payout_amount DECIMAL(10, 2) NOT NULL,
  status VARCHAR(50) DEFAULT 'pending',
  paid_at TIMESTAMP,
  payout_id INTEGER REFERENCES vendor_payouts(id),
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_commission_status CHECK (status IN ('pending', 'held', 'released', 'paid'))
);

-- ============================================
-- AI AGENT TABLES
-- ============================================

-- Agent Identities
CREATE TABLE IF NOT EXISTS agent_identities (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  role VARCHAR(50) NOT NULL,
  api_key_hash VARCHAR(255) NOT NULL UNIQUE,
  is_active BOOLEAN DEFAULT true,
  last_used_at TIMESTAMP,
  request_count INTEGER DEFAULT 0,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_agent_role CHECK (role IN ('OWNER', 'LEADER', 'VENDOR_ONBOARDING', 'BOOKING_MANAGER', 'CALENDAR_SYNC', 'PRICING', 'MARKETING', 'SUPPORT', 'FINANCE'))
);

-- Agent Tasks
CREATE TABLE IF NOT EXISTS agent_tasks (
  id SERIAL PRIMARY KEY,
  task_id VARCHAR(100) UNIQUE NOT NULL,
  agent_id INTEGER REFERENCES agent_identities(id),
  role VARCHAR(50) NOT NULL,
  action VARCHAR(255) NOT NULL,
  payload JSONB NOT NULL,
  status VARCHAR(50) DEFAULT 'QUEUED',
  priority INTEGER DEFAULT 5,
  result JSONB,
  error TEXT,
  retry_count INTEGER DEFAULT 0,
  max_retries INTEGER DEFAULT 3,
  created_at TIMESTAMP DEFAULT NOW(),
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_task_status CHECK (status IN ('QUEUED', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED'))
);

-- Agent Audit Logs
CREATE TABLE IF NOT EXISTS agent_audit_logs (
  id SERIAL PRIMARY KEY,
  agent_id INTEGER REFERENCES agent_identities(id),
  action VARCHAR(255) NOT NULL,
  resource_type VARCHAR(100),
  resource_id VARCHAR(255),
  status VARCHAR(50) NOT NULL,
  details JSONB,
  ip_address VARCHAR(45),
  user_agent TEXT,
  duration_ms INTEGER,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_audit_status CHECK (status IN ('SUCCESS', 'FAILURE', 'PENDING'))
);

-- Agent Idempotency Keys
CREATE TABLE IF NOT EXISTS agent_idempotency_keys (
  id SERIAL PRIMARY KEY,
  agent_id INTEGER NOT NULL REFERENCES agent_identities(id),
  idempotency_key VARCHAR(255) NOT NULL,
  response JSONB NOT NULL,
  status_code INTEGER,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(agent_id, idempotency_key)
);

-- ============================================
-- PRICING & MARKETING TABLES
-- ============================================

-- Pricing Rules Table
CREATE TABLE IF NOT EXISTS pricing_rules (
  id SERIAL PRIMARY KEY,
  service_id INTEGER NOT NULL REFERENCES services(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  rule_type VARCHAR(50) NOT NULL,
  multiplier DECIMAL(5, 2) DEFAULT 1.0,
  fixed_adjustment DECIMAL(10, 2) DEFAULT 0,
  start_date DATE,
  end_date DATE,
  days_of_week INTEGER[],
  min_nights INTEGER,
  is_active BOOLEAN DEFAULT true,
  priority INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_rule_type CHECK (rule_type IN ('seasonal', 'weekend', 'early_bird', 'last_minute', 'long_stay', 'custom'))
);

-- Reviews Table
CREATE TABLE IF NOT EXISTS reviews (
  id SERIAL PRIMARY KEY,
  booking_id INTEGER UNIQUE NOT NULL REFERENCES bookings(id),
  service_id INTEGER NOT NULL REFERENCES services(id),
  user_id INTEGER NOT NULL REFERENCES users(id),
  customer_name VARCHAR(255) NOT NULL,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  cleanliness_rating INTEGER CHECK (cleanliness_rating >= 1 AND cleanliness_rating <= 5),
  communication_rating INTEGER CHECK (communication_rating >= 1 AND communication_rating <= 5),
  value_rating INTEGER CHECK (value_rating >= 1 AND value_rating <= 5),
  location_rating INTEGER CHECK (location_rating >= 1 AND location_rating <= 5),
  comment TEXT,
  response TEXT,
  response_date TIMESTAMP,
  is_public BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,
  helpful_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ============================================
-- NOTIFICATIONS & MESSAGING
-- ============================================

-- Notifications Table
CREATE TABLE IF NOT EXISTS notifications (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  type VARCHAR(50) DEFAULT 'info',
  category VARCHAR(50),
  is_read BOOLEAN DEFAULT false,
  link VARCHAR(500),
  action_text VARCHAR(100),
  image_url VARCHAR(500),
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  read_at TIMESTAMP,
  CONSTRAINT valid_notification_type CHECK (type IN ('info', 'success', 'warning', 'error', 'booking', 'payment', 'review')),
  CONSTRAINT valid_category CHECK (category IN ('booking', 'payment', 'review', 'system', 'marketing', 'support'))
);

-- Messages Table (Customer-Vendor Communication)
CREATE TABLE IF NOT EXISTS messages (
  id SERIAL PRIMARY KEY,
  booking_id INTEGER REFERENCES bookings(id),
  sender_type VARCHAR(20) NOT NULL,
  sender_id INTEGER,
  sender_name VARCHAR(255) NOT NULL,
  sender_email VARCHAR(255),
  recipient_id INTEGER REFERENCES users(id),
  subject VARCHAR(255),
  message TEXT NOT NULL,
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_sender_type CHECK (sender_type IN ('customer', 'vendor', 'admin', 'system'))
);

-- ============================================
-- ANALYTICS & REPORTING TABLES
-- ============================================

-- Service Views Tracking
CREATE TABLE IF NOT EXISTS service_views (
  id SERIAL PRIMARY KEY,
  service_id INTEGER NOT NULL REFERENCES services(id) ON DELETE CASCADE,
  user_id INTEGER REFERENCES users(id),
  ip_address VARCHAR(45),
  user_agent TEXT,
  referrer VARCHAR(500),
  country VARCHAR(100),
  city VARCHAR(100),
  viewed_at TIMESTAMP DEFAULT NOW()
);

-- Search Queries (for analytics)
CREATE TABLE IF NOT EXISTS search_queries (
  id SERIAL PRIMARY KEY,
  query TEXT NOT NULL,
  filters JSONB,
  results_count INTEGER,
  clicked_service_id INTEGER REFERENCES services(id),
  ip_address VARCHAR(45),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Platform Settings
CREATE TABLE IF NOT EXISTS platform_settings (
  id SERIAL PRIMARY KEY,
  key VARCHAR(255) UNIQUE NOT NULL,
  value JSONB NOT NULL,
  data_type VARCHAR(50) DEFAULT 'json',
  description TEXT,
  is_public BOOLEAN DEFAULT false,
  updated_by INTEGER REFERENCES users(id),
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT valid_data_type CHECK (data_type IN ('string', 'number', 'boolean', 'json', 'array'))
);

-- Activity Logs (User Actions)
CREATE TABLE IF NOT EXISTS activity_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50),
  resource_id INTEGER,
  details JSONB,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ============================================
-- INDEXES FOR PERFORMANCE
-- ============================================

-- Users indexes
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
CREATE INDEX IF NOT EXISTS idx_users_is_approved ON users(is_approved);
CREATE INDEX IF NOT EXISTS idx_users_stripe_account ON users(stripe_connected_account_id);

-- Services indexes
CREATE INDEX IF NOT EXISTS idx_services_user_id ON services(user_id);
CREATE INDEX IF NOT EXISTS idx_services_type ON services(type);
CREATE INDEX IF NOT EXISTS idx_services_available ON services(available);
CREATE INDEX IF NOT EXISTS idx_services_location ON services(location);
CREATE INDEX IF NOT EXISTS idx_services_rating ON services(rating DESC);

-- Bookings indexes
CREATE INDEX IF NOT EXISTS idx_bookings_user_id ON bookings(user_id);
CREATE INDEX IF NOT EXISTS idx_bookings_service_id ON bookings(service_id);
CREATE INDEX IF NOT EXISTS idx_bookings_status ON bookings(status);
CREATE INDEX IF NOT EXISTS idx_bookings_payment_status ON bookings(payment_status);
CREATE INDEX IF NOT EXISTS idx_bookings_dates ON bookings(start_date, end_date);
CREATE INDEX IF NOT EXISTS idx_bookings_reference ON bookings(booking_reference);
CREATE INDEX IF NOT EXISTS idx_bookings_customer_email ON bookings(customer_email);
CREATE INDEX IF NOT EXISTS idx_bookings_created_at ON bookings(created_at DESC);

-- Calendar indexes
CREATE INDEX IF NOT EXISTS idx_calendar_sources_user_id ON calendar_sources(user_id);
CREATE INDEX IF NOT EXISTS idx_calendar_sources_service_id ON calendar_sources(service_id);
CREATE INDEX IF NOT EXISTS idx_calendar_events_dates ON calendar_events(start_date, end_date);
CREATE INDEX IF NOT EXISTS idx_calendar_events_service_id ON calendar_events(service_id);

-- Stripe & Payment indexes
CREATE INDEX IF NOT EXISTS idx_stripe_accounts_user_id ON stripe_connect_accounts(user_id);
CREATE INDEX IF NOT EXISTS idx_stripe_accounts_stripe_id ON stripe_connect_accounts(stripe_account_id);
CREATE INDEX IF NOT EXISTS idx_vendor_payouts_user_id ON vendor_payouts(user_id);
CREATE INDEX IF NOT EXISTS idx_vendor_payouts_status ON vendor_payouts(status);
CREATE INDEX IF NOT EXISTS idx_transactions_booking_id ON transactions(booking_id);
CREATE INDEX IF NOT EXISTS idx_transactions_user_id ON transactions(user_id);
CREATE INDEX IF NOT EXISTS idx_transactions_type ON transactions(transaction_type);
CREATE INDEX IF NOT EXISTS idx_commissions_booking_id ON commissions(booking_id);
CREATE INDEX IF NOT EXISTS idx_commissions_user_id ON commissions(user_id);
CREATE INDEX IF NOT EXISTS idx_commissions_status ON commissions(status);

-- Agent indexes
CREATE INDEX IF NOT EXISTS idx_agent_tasks_status ON agent_tasks(status);
CREATE INDEX IF NOT EXISTS idx_agent_tasks_role ON agent_tasks(role);
CREATE INDEX IF NOT EXISTS idx_agent_tasks_created ON agent_tasks(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_agent_audit_agent_id ON agent_audit_logs(agent_id);
CREATE INDEX IF NOT EXISTS idx_agent_audit_created ON agent_audit_logs(created_at DESC);

-- Notifications indexes
CREATE INDEX IF NOT EXISTS idx_notifications_user_id ON notifications(user_id);
CREATE INDEX IF NOT EXISTS idx_notifications_is_read ON notifications(is_read);
CREATE INDEX IF NOT EXISTS idx_notifications_created ON notifications(created_at DESC);

-- Messages indexes
CREATE INDEX IF NOT EXISTS idx_messages_booking_id ON messages(booking_id);
CREATE INDEX IF NOT EXISTS idx_messages_recipient_id ON messages(recipient_id);
CREATE INDEX IF NOT EXISTS idx_messages_is_read ON messages(is_read);

-- Reviews indexes
CREATE INDEX IF NOT EXISTS idx_reviews_service_id ON reviews(service_id);
CREATE INDEX IF NOT EXISTS idx_reviews_user_id ON reviews(user_id);
CREATE INDEX IF NOT EXISTS idx_reviews_rating ON reviews(rating);

-- Analytics indexes
CREATE INDEX IF NOT EXISTS idx_service_views_service_id ON service_views(service_id);
CREATE INDEX IF NOT EXISTS idx_service_views_viewed_at ON service_views(viewed_at DESC);
CREATE INDEX IF NOT EXISTS idx_search_queries_created ON search_queries(created_at DESC);

-- ============================================
-- FUNCTIONS & TRIGGERS
-- ============================================

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply triggers to all tables with updated_at
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_services_updated_at BEFORE UPDATE ON services 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_bookings_updated_at BEFORE UPDATE ON bookings 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_pricing_rules_updated_at BEFORE UPDATE ON pricing_rules 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_reviews_updated_at BEFORE UPDATE ON reviews 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Function to generate booking reference
CREATE OR REPLACE FUNCTION generate_booking_reference()
RETURNS TRIGGER AS $$
BEGIN
    NEW.booking_reference = 'BK' || TO_CHAR(NOW(), 'YYYYMMDD') || LPAD(NEW.id::TEXT, 6, '0');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-generate booking reference
CREATE TRIGGER set_booking_reference BEFORE INSERT ON bookings 
  FOR EACH ROW EXECUTE FUNCTION generate_booking_reference();

-- Function to calculate commission and vendor payout
CREATE OR REPLACE FUNCTION calculate_booking_financials()
RETURNS TRIGGER AS $$
DECLARE
    vendor_commission_rate DECIMAL(5,2);
BEGIN
    -- Get vendor's commission rate
    SELECT commission_rate INTO vendor_commission_rate
    FROM users WHERE id = NEW.user_id;
    
    -- Calculate commission and vendor payout
    NEW.commission = NEW.total_price * (vendor_commission_rate / 100);
    NEW.vendor_payout = NEW.total_price - NEW.commission;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-calculate financials
CREATE TRIGGER calculate_booking_financials_trigger 
  BEFORE INSERT OR UPDATE OF total_price ON bookings 
  FOR EACH ROW EXECUTE FUNCTION calculate_booking_financials();

-- Function to update service rating
CREATE OR REPLACE FUNCTION update_service_rating()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE services
    SET rating = (SELECT AVG(rating) FROM reviews WHERE service_id = NEW.service_id),
        reviews_count = (SELECT COUNT(*) FROM reviews WHERE service_id = NEW.service_id)
    WHERE id = NEW.service_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to update service rating when review is added
CREATE TRIGGER update_service_rating_trigger AFTER INSERT ON reviews 
  FOR EACH ROW EXECUTE FUNCTION update_service_rating();

-- Function to create commission record
CREATE OR REPLACE FUNCTION create_commission_record()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.status = 'confirmed' AND NEW.payment_status = 'paid' THEN
        INSERT INTO commissions (
            booking_id, user_id, booking_amount, commission_rate, 
            commission_amount, vendor_payout_amount, status
        ) VALUES (
            NEW.id, NEW.user_id, NEW.total_price,
            (SELECT commission_rate FROM users WHERE id = NEW.user_id),
            NEW.commission, NEW.vendor_payout, 'pending'
        ) ON CONFLICT DO NOTHING;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to create commission record
CREATE TRIGGER create_commission_trigger AFTER UPDATE ON bookings 
  FOR EACH ROW EXECUTE FUNCTION create_commission_record();

-- ============================================
-- DEFAULT DATA & SETTINGS
-- ============================================

-- Insert platform settings
INSERT INTO platform_settings (key, value, description, is_public) VALUES
  ('default_commission', '{"percentage": 12.5}'::jsonb, 'Default commission rate for new vendors', false),
  ('payout_schedule', '{"frequency": "weekly", "day": "friday"}'::jsonb, 'Vendor payout schedule', false),
  ('platform_email', '{"email": "info@islandloafvendor.com"}'::jsonb, 'Platform contact email', true),
  ('platform_name', '{"name": "IslandLoaf"}'::jsonb, 'Platform name', true),
  ('currency', '{"default": "USD", "supported": ["USD", "LKR", "EUR", "GBP"]}'::jsonb, 'Supported currencies', true),
  ('booking_hold_days', '{"days": 7}'::jsonb, 'Days to hold commission before payout', false),
  ('min_payout_amount', '{"amount": 50}'::jsonb, 'Minimum payout amount in USD', false),
  ('commission_tiers', '{"standard": 12.5, "premium": 10, "new": 15}'::jsonb, 'Commission rate tiers', false)
ON CONFLICT (key) DO NOTHING;

-- ============================================
-- ROW LEVEL SECURITY (RLS) POLICIES
-- ============================================

-- Enable RLS on all tables
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE services ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;
ALTER TABLE calendar_sources ENABLE ROW LEVEL SECURITY;
ALTER TABLE calendar_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE pricing_rules ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;
ALTER TABLE vendor_payouts ENABLE ROW LEVEL SECURITY;
ALTER TABLE commissions ENABLE ROW LEVEL SECURITY;

-- Public policies for customer website (read-only)
CREATE POLICY "Public can view available services" ON services
  FOR SELECT USING (available = true);

CREATE POLICY "Public can view service reviews" ON reviews
  FOR SELECT USING (is_public = true);

-- Vendor policies
CREATE POLICY "Vendors can view own data" ON users
  FOR SELECT USING (id = current_setting('app.current_user_id', true)::integer OR 
                    (SELECT role FROM users WHERE id = current_setting('app.current_user_id', true)::integer) = 'admin');

CREATE POLICY "Vendors can manage own services" ON services
  FOR ALL USING (user_id = current_setting('app.current_user_id', true)::integer OR 
                 (SELECT role FROM users WHERE id = current_setting('app.current_user_id', true)::integer) = 'admin');

CREATE POLICY "Vendors can view own bookings" ON bookings
  FOR SELECT USING (user_id = current_setting('app.current_user_id', true)::integer OR 
                    (SELECT role FROM users WHERE id = current_setting('app.current_user_id', true)::integer) = 'admin');

CREATE POLICY "Vendors can view own payouts" ON vendor_payouts
  FOR SELECT USING (user_id = current_setting('app.current_user_id', true)::integer OR 
                    (SELECT role FROM users WHERE id = current_setting('app.current_user_id', true)::integer) = 'admin');

CREATE POLICY "Vendors can view own commissions" ON commissions
  FOR SELECT USING (user_id = current_setting('app.current_user_id', true)::integer OR 
                    (SELECT role FROM users WHERE id = current_setting('app.current_user_id', true)::integer) = 'admin');

-- Guest booking policy (for customer website)
CREATE POLICY "Anyone can create bookings" ON bookings
  FOR INSERT WITH CHECK (true);

-- ============================================
-- VIEWS FOR REPORTING
-- ============================================

-- Vendor Dashboard Summary View
CREATE OR REPLACE VIEW vendor_dashboard_summary AS
SELECT 
    u.id as vendor_id,
    u.business_name,
    COUNT(DISTINCT s.id) as total_services,
    COUNT(DISTINCT b.id) as total_bookings,
    COUNT(DISTINCT CASE WHEN b.status = 'pending' THEN b.id END) as pending_bookings,
    COUNT(DISTINCT CASE WHEN b.status = 'confirmed' THEN b.id END) as confirmed_bookings,
    COUNT(DISTINCT CASE WHEN b.status = 'completed' THEN b.id END) as completed_bookings,
    COALESCE(SUM(CASE WHEN b.payment_status = 'paid' THEN b.total_price ELSE 0 END), 0) as total_revenue,
    COALESCE(SUM(CASE WHEN b.payment_status = 'paid' THEN b.vendor_payout ELSE 0 END), 0) as total_earnings,
    COALESCE(SUM(CASE WHEN b.payment_status = 'paid' THEN b.commission ELSE 0 END), 0) as total_commission_paid,
    COALESCE(AVG(r.rating), 0) as average_rating,
    COUNT(DISTINCT r.id) as total_reviews
FROM users u
LEFT JOIN services s ON u.id = s.user_id
LEFT JOIN bookings b ON u.id = b.user_id
LEFT JOIN reviews r ON u.id = r.user_id
WHERE u.role = 'vendor'
GROUP BY u.id, u.business_name;

-- Admin Platform Summary View
CREATE OR REPLACE VIEW platform_summary AS
SELECT 
    COUNT(DISTINCT u.id) as total_vendors,
    COUNT(DISTINCT CASE WHEN u.is_approved THEN u.id END) as approved_vendors,
    COUNT(DISTINCT CASE WHEN NOT u.is_approved THEN u.id END) as pending_vendors,
    COUNT(DISTINCT s.id) as total_services,
    COUNT(DISTINCT b.id) as total_bookings,
    COALESCE(SUM(b.total_price), 0) as total_booking_value,
    COALESCE(SUM(b.commission), 0) as total_commission_earned,
    COALESCE(SUM(b.vendor_payout), 0) as total_vendor_payouts,
    COUNT(DISTINCT r.id) as total_reviews,
    COALESCE(AVG(r.rating), 0) as platform_average_rating
FROM users u
LEFT JOIN services s ON u.id = s.user_id
LEFT JOIN bookings b ON u.id = b.user_id
LEFT JOIN reviews r ON s.id = r.service_id
WHERE u.role = 'vendor';

-- ============================================
-- SUCCESS MESSAGE
-- ============================================
DO $$
BEGIN
    RAISE NOTICE '========================================';
    RAISE NOTICE '✅ IslandLoaf Vendor Platform Setup Complete!';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'Tables created: 30+';
    RAISE NOTICE 'Indexes created: 50+';
    RAISE NOTICE 'Functions created: 6';
    RAISE NOTICE 'Triggers created: 7';
    RAISE NOTICE 'Views created: 2';
    RAISE NOTICE 'RLS Policies: Enabled';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'Next steps:';
    RAISE NOTICE '1. Run: npm run setup:users';
    RAISE NOTICE '2. Run: npm run agent:create-key';
    RAISE NOTICE '3. Deploy to Replit';
    RAISE NOTICE '========================================';
END $$;

-- Return success confirmation
SELECT 
    'Database setup complete! ✅' as status,
    (SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public') as tables_created,
    NOW() as completed_at;